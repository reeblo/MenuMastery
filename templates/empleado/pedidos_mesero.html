{% extends "empleado/base.html" %}

{% block title %}Pedidos Listos - Mesero{% endblock %}

{% block content %}

<div class="pedidos-container">
    <h2 class="mb-4">Pedidos Listos para Servir</h2>
    {% if pedidos_listos %}
    <div class="pedidos-list">
        {% for pedido in pedidos_listos %}
        <div class="pedido-card">
            <div class="pedido-header">
                <h3 class="pedido-title">Pedido #{{ pedido.id }}</h3>
                <span class="pedido-time">{{ pedido.fecha.strftime('%H:%M') }}</span>
            </div>
            <p class="pedido-mesa"><strong>Mesa:</strong> {{ pedido.mesa or 'No especificada' }}</p>
            <ul class="pedido-items">
                {% for item in pedido.items %}
                <li>{{ item.cantidad }}x {{ item.plato.nombre }}</li>
                {% endfor %}
            </ul>
            <div class="d-flex justify-content-end gap-2">
                <form method="POST" action="{{ url_for('entregar_pedido', id=pedido.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-success btn-marcar-entregado">
                        <i class="fas fa-check-circle me-2"></i>Marcar como Entregado
                    </button>
                </form>
                <a href="{{ url_for('detalle_pedido', pedido_id=pedido.id) }}" class="btn btn-info">
                    <i class="fas fa-eye me-1"></i> Ver Detalle
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        No hay pedidos listos para servir en este momento.
    </div>
    {% endif %}

    <hr class="my-5">
    <h2 class="mb-4">Tus Pedidos Realizados</h2>
    {% if pedidos_mesero %}
    <div class="pedidos-list">
        {% for pedido in pedidos_mesero %}
        <div class="pedido-card">
            <div class="pedido-header">
                <h3 class="pedido-title">Pedido #{{ pedido.id }}</h3>
                <span class="pedido-time">{{ pedido.fecha.strftime('%H:%M') }}</span>
            </div>
            <p class="pedido-mesa"><strong>Mesa:</strong> {{ pedido.mesa or 'No especificada' }}</p>
            <span class="badge bg-info">Estado: {{ pedido.estado }}</span>
            <ul class="pedido-items">
                {% for item in pedido.items %}
                <li>{{ item.cantidad }}x {{ item.plato.nombre }}</li>
                {% endfor %}
            </ul>
    </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        No has realizado pedidos como mesero.
    </div>
    {% endif %}
</div>

<script>
// Actualización en tiempo real
const eventSource = new EventSource('/stream-pedidos');
eventSource.onmessage = function(e) {
    if (e.data === 'actualizar') {
        location.reload();
    }
};

// Confirmación antes de marcar como entregado
document.querySelectorAll('.btn-marcar-entregado').forEach(btn => {
    btn.addEventListener('click', function(e) {
        if (!confirm('¿Confirmar entrega de este pedido?')) {
            e.preventDefault();
        }
    });
});

// En pedidos_cocina.html y pedidos_mesero.html
const eventSource = new EventSource('/stream-pedidos');
eventSource.onmessage = function(e) {
    if (e.data === 'actualizar') {
        // Mostrar notificación
        showToast('¡Nuevo pedido recibido!', 'info');
        // Recargar la página después de un breve retraso
        setTimeout(() => location.reload(), 2000);
    }
};

function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '1100';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type} border-0`;
    toast.role = 'alert';
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.style.marginBottom = '10px';

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    document.getElementById('toast-container').appendChild(toast);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}
</script>
{% endblock %}